events {
    worker_connections 1024;
}

http {
    # Upstream para Tasks Service con 2 r√©plicas
    upstream tasks_backend {
        # Round-robin load balancing (default)
        server tasks-service-1:3001;
        server tasks-service-2:3001;
        
        # Health check configuration
        keepalive 32;
    }

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Server configuration
    server {
        listen 80;
        server_name localhost;

        # Proxy settings
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Location for Tasks API
        location /api/tasks {
            proxy_pass http://tasks_backend/api/tasks;
            
            # Additional headers
            add_header X-Load-Balancer "NGINX" always;
            add_header X-Upstream-Server $upstream_addr always;
        }

        # Location for health check
        location /health {
            proxy_pass http://tasks_backend/health;
            
            add_header X-Load-Balancer "NGINX" always;
            add_header X-Upstream-Server $upstream_addr always;
        }

        # NGINX status page (optional)
        location /nginx-status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 172.0.0.0/8;
            deny all;
        }

        # Root location
        location / {
            return 200 '{"status":"OK","service":"NGINX Load Balancer","message":"Load balancer is running. Use /api/tasks for API access"}';
            add_header Content-Type application/json;
        }
    }
}
